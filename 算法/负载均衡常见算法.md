## 负载均衡常见算法

### 随机法

如果没有配置权重，所有服务器被访问到的概率都是相同的。配置权重的话，权重大的服务器被访问的概率更大。

部分机器可能在一段时间内无法被随机到。

### 平滑加权轮询算法

#### 一般的加权轮询

假设a、b、c 三个节点的权值分别为 {4，1，3}，那么一次轮询调用的顺序为：

```text
a, a, a, a, b, c, c, c
```

缺点：

高权重的节点，在调用初期会承受较大的压力，导致机器负载突然增高，而其他机器的负载很低，因为整个轮询调用过程不是很平滑。

#### 平滑的加权轮询算法

轮询调用的次数和他们的权重一致，且不会一段时间内集中到某一台权重比较高的节点上。

过程

##### 基本概念

- `weight`：配置文件中设置的权重值，整个过程保持不变
- `current_weight`：回源节点当前的权重值，初始值为0，每一轮选择中，该值最大的节点会被选中，然后重新计算值
- `effective_weight`：变化权重值，初始值等于 weight，用于动态调整节点被选中的概率（如果节点发生宕机，则会降低权重值）
- `total_weight`：所有节点权重值之和

##### 计算过程

1. 初始化：

   weight 赋值为配置文件中的值，保持不变

   current_weight 赋值为0

   effective_weight 赋值为 weight

   total_weight 为所有weight 之和

2. 计算 current_weight

   每个节点的 current_weight 加上对应的 weight 值

3. 选取节点

   选取 current_weight 值最大的那个节点，接受本次调用

   该节点的 current_weight 减去 total_weight

4. 重复步骤2和3，直到所有节点的 current_weight 值为0，此时刚好重复 total_weight 次，结束一次负载均衡。

##### 实例

```text
a	b	c
0	0	0	# 初始化

4	1	3	# 加上 weight
-4	1	3	# 选取 a 节点，a节点减去8

# 重复2和3步骤
0	2	6	# 加上 weight
0	2	-2	# 选择 c 节点，b节点减去8

4	3	1	# 加上 weight
-4	3	1	# 选择 a 节点，a节点减去8

0	4	4	# 加上 weight
0 	-4	4	# 选择 b 节点，b节点减去8

4	-3	7	# 加上 weight
4	-3	-1	# 选择 c 节点，c节点减去8

8	-2	2	# 加上 weight
0	-2	2	# 选择 a 节点，a节点减去8

4	-1	5	# 加上 weight
4	-1	-3	# 选择 c 节点，c节点减去8

8	0	0	# 加上 weight
0	0	0	# 选择 a 节点，c节点减去8

# 一次轮询结束
```

以上过程输出选择的顺序：

```text
a, c, a, b, c, a, c, a
```

### 两次随机法

在随机法的基础上多加了一次随机，多选出一个服务器。根据两台机器的负载情况选出最适合的服务器。可以动态地调节后端节点的负载。

### 哈希法

将请求的参数信息通过哈希函数转换成一个哈希值，再分配到对应的服务器去处理。

服务器数量不变的情况下，相同参数的请求总是发到同一台服务器上。

### 一致性 Hash 法

常规哈希法在服务器数量变化时，哈希值会重新落在不同的服务器上。一致性哈希法将数据和节点都映射到一个哈希环上，然后根据哈希值的顺序来确定数据属于哪个节点。增删服务器时，不会导致服务器集群的哈希键值重新分布。

### 最小连接法

遍历服务器节点列表，并选取其中连接数最小的一台服务器来响应请求。

该算法默认一个服务器连接数越多，负载越高。然而实际情况是有些连接消耗资源，有些连接不怎么消耗资源。

### 最少活跃法

与最小连接法类似，以活动连接数为标准，活动连接数可以理解为当前正在处理的请求数。活跃数越低，说明节点处理请求的速度越快，就可以为它分配更多的请求。

### 最快响应时间法

以响应时间为标准，来选择具体由哪一台服务器处理。由客户端维持每个服务器的响应时间，每次请求挑选时间最短的。

