Redis 哨兵机制

一种高可用性解决方案，用于监控 Redis 主从集群，自动完成**主从切换**，以实现**故障自动恢复**和通知。

主要功能：

- 监控：哨兵不断监控 Redis 主从节点的运行状态，定期发送 PING 请求检查节点是否正常。
- 自动故障转移：主节点发生故障时，哨兵会选举一个从节点提升为新的主节点，并通知客户端更新，从而实现高可用。
- 通知：哨兵可以发送通知，快速处理 Redis 实例的状态变化。

#### 哨兵机制由来

主从节点中如果采用**读写分离**的模式，即主节点负责写请求，从节点负责读请求，假设主节点宕机了，没有新的节点顶替的话，就会出现很长一段时间写请求没响应的情况。

针对这个情况出现了哨兵机制。如果主节点挂了，将从节点切换成主节点，从而最大限度地减少停机时间和数据丢失。

- 哨兵节点：对 Redis 主从服务节点进行监控。
- Redis 节点：包括 master 和 slave 节点，Redis 提供服务的实例。

一般至少三台哨兵组成哨兵集群，且为单数。

#### 节点下线

##### 1）主观下线

哨兵每隔 1s 发送 ping 命令给所有的节点，如果超过一段时间（down-after-milliseconds）没收到节点的 pong 回复，就会认为这个节点**主观下线**。

##### 2）客观下线

只针对主节点。

如果一个主节点被一个哨兵判断主观下线了，该哨兵会发起投票，询问其余哨兵，如果认为下线的总投票数大于 quorum（集群总数/2 + 1），则判定该主节点**客观下线**。

此时将进行主从切换。

#### 选举

##### 哨兵 leader 选举

该哨兵会成为候选者，如果有两个候选者，则所有哨兵节点进行投票，某个候选者拿到哨兵集群半数及以上的赞成票，就会成为 leader。

##### Redis 主节点选举

哨兵 leader 会操作主从切换。首先把已经下线的节点剔除，然后从正常的从节点中选择主节点。

选择的依据有：

- 根据从节点的优先级（slave-priority），值越小优先级越高。
- 如果优先级配置都相同，则根据主从复制的 offset，offset 越大说明同步的数据越多，优先级越高。
- 如果 offset 也相同，则根据 ID 号，ID 最小的成为主节点。

选好主节点之后，哨兵 leader 会让其他从节点全部成为新 master 节点的 slave 节点。

利用 redis 的发布/订阅机制，把新主节点的 IP 和端口信息推送给客户端，主从切换到此结束。

如果主节点重新上线，哨兵集群会向它发送 slaveof 命令，让它成为新节点的从节点。